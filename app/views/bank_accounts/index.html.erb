<% content_for :title do %>
  Zarządzanie kontami bankowymi
<% end %>

<h1>Zarządzanie kontami bankowymi</h1>

<div class="well">
  <div class="row">
    <div class="col-md-12">
      <h4>Akcje</h4>
      <%= link_to 'Zarządzaj numerami kont', upload_associations_bank_accounts_path, class: 'btn btn-sm btn-success' %>
      <%= link_to 'Importuj dane Elixir', upload_elixir_bank_accounts_path, class: 'btn btn-sm btn-primary' %>
      <%= link_to 'Zobacz logi importu', logs_bank_accounts_path, class: 'btn btn-sm btn-info' %>
    </div>
  </div>
</div>

<% if @import_logs.any? %>
<div class="well">
  <h3>Ostatnie importy</h3>
  <div class="table-responsive">
    <table class="table table-striped table-condensed">
      <thead>
        <tr>
          <th>Data</th>
          <th>Jednostka</th>
          <th>Plik</th>
          <th>Status</th>
          <th>Sukces/Błędy</th>
        </tr>
      </thead>
      <tbody>
        <% @import_logs.each do |log| %>
          <tr class="<%= log.error_count > 0 ? 'danger' : 'success' %>">
            <td><%= log.import_date.strftime('%Y-%m-%d %H:%M') if log.import_date %></td>
            <td><%= log.unit.name if log.unit %></td>
            <td><%= log.file_name %></td>
            <td>
              <% if log.successful? %>
                <span class="label label-success">Sukces</span>
              <% elsif log.partially_successful? %>
                <span class="label label-warning">Częściowy</span>
              <% else %>
                <span class="label label-danger">Błąd</span>
              <% end %>
            </td>
            <td><%= log.success_count %>/<%= log.error_count %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  <div class="text-right">
    <%= link_to 'Zobacz wszystkie logi', logs_bank_accounts_path, class: 'btn btn-sm btn-default' %>
  </div>
</div>
<% end %>

<div class="well">
  <h3>Lista jednostek z kontami bankowymi</h3>
  <table class="table table-striped table-condensed">
    <thead>
      <tr>
        <th>Kod</th>
        <th>Nazwa</th>
        <th>Numer konta</th>
        <th>Auto import</th>
        <th>Akcje</th>
      </tr>
    </thead>
    <tbody>
      <% @units.each do |unit| %>
        <tr>
          <td><%= unit.code %></td>
          <td><%= unit.name %></td>
          <td><%= unit.bank_account.present? ? format_bank_account(unit.bank_account) : "-" %></td>
          <td>
            <%= link_to toggle_auto_import_bank_accounts_path(unit_id: unit.id), 
                method: :post,
                class: "btn btn-xs #{unit.auto_bank_import ? 'btn-success' : 'btn-default'}",
                data: { confirm: "Czy na pewno chcesz #{unit.auto_bank_import ? 'wyłączyć' : 'włączyć'} auto import dla jednostki #{unit.name}?" } do %>
              <%= unit.auto_bank_import ? 'Włączony' : 'Wyłączony' %>
            <% end %>
          </td>
          <td>
            <%= link_to 'Edytuj', edit_unit_path(unit), class: 'btn btn-xs btn-success' %>
            
            <% current_year = Date.today.year %>
            <% bank_journal = unit.journals.find_by(year: current_year, journal_type_id: JournalType::BANK_TYPE_ID) %>
            
            <% if bank_journal && bank_journal.is_open %>
              <%= link_to 'Usuń wpisy z ' + current_year.to_s, 
                  clear_journal_entries_bank_accounts_path(unit_id: unit.id, year: current_year), 
                  class: 'btn btn-xs btn-danger',
                  data: { confirm: "Ta operacja usunie wszystkie wpisy z książki bankowej jednostki #{unit.name} za rok #{current_year}. Czy na pewno chcesz kontynuować?" } %>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div> 